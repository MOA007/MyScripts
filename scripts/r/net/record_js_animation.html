<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge, chrome=1" />
  <title>untitled</title>
  <script src="https://cdn.rawgit.com/dataarts/dat.gui/d5b6178e/build/dat.gui.js"></script>
  <script src="https://cdn.rawgit.com/spite/ccapture.js/0bb38d6f/build/CCapture.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/pixi.js/4.3.5/pixi.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script> -->
  <script src="tween.umd.js"></script>
</head>

<body>

  <script>

    let renderer, stage;
    let num_circles = 100;
    let circles = new Array();
    let velocity = { max_vx: 3, min_vx: 1, max_vy: 3, min_vy: 1 };
    let capturer = null;

    let options = {
      /* Recording options */
      format: 'webm',
      framerate: '60FPS',
      start: function () { startRecording(); },
      stop: function () { stopRecording(); }
    }

    var gui = new dat.gui.GUI();

    let recording = gui.addFolder('Recording');
    recording.add(options, 'format', ['gif', 'webm-mediarecorder', 'webm']);
    recording.add(options, 'framerate', ['10FPS', '30FPS', '60FPS', '120FPS']);
    recording.add(options, 'start');
    recording.add(options, 'stop');
    function createCircles() {
      for (let i = 0; i < num_circles; i++) {
        let circle = new PIXI.Graphics();
        let radius = Math.floor(Math.random() * (20 - 8 + 1)) + 8;
        circle.beginFill('0x' + randomColor());
        circle.drawCircle(0, 0, radius);
        circle.endFill();
        /* Math.floor(Math.random() * (max - min + 1)) + min; */
        circle.x = Math.floor(Math.random() * (renderer.width - radius - radius + 1)) + radius;
        circle.y = Math.floor(Math.random() * (renderer.height - radius - radius + 1)) + radius;

        let vx = Math.random() * (velocity.max_vx - velocity.min_vx) + velocity.min_vx;
        vx = Math.random() > 0.5 ? vx : -vx;
        let vy = Math.random() * (velocity.max_vy - velocity.min_vy) + velocity.min_vy;
        vy = Math.random() > 0.5 ? vy : -vy;

        circle.radius = radius;
        circle.vx = vx;
        circle.vy = vy;
        stage.addChild(circle);
        circles.push(circle);

        const tween = new TWEEN.Tween({ x: 0, y: 0 }) // Create a new tween that modifies 'coords'.
          .to({ x: 300, y: 200 }, 2000) // Move to (300, 200) in 1 second.
          .easing(TWEEN.Easing.Quadratic.Out) // Use an easing function to make the animation smooth.
          .onUpdate((v) => {
            circle.x = v.x;
            circle.y = v.y;
          })
          .start(); // Start the tween immediately.
      }
    }
    function initRecording() {
      capturer = new CCapture({
        verbose: true,
        display: false,
        framerate: parseInt(options.framerate),
        motionBlurFrames: 0,
        quality: 100,
        format: options.format,
        workersPath: 'dist/src/',
        timeLimit: 0,
        frameLimit: 0,
        autoSaveTime: 0,
      });
    }
    function startRecording() {
      initRecording();
      capturer.start();
    }
    function stopRecording() {
      capturer.stop();
      capturer.save();
    }

    function resetAnimation() {
      renderer = PIXI.autoDetectRenderer(256, 256, { antialias: true, transparent: false });
      renderer.autoResize = false;
      renderer.resize(window.innerWidth, window.innerHeight);

      /* Add the canvas to the HTML document */
      let c = document.getElementsByTagName("canvas")[0];
      if (c)
        document.body.removeChild(c);
      document.body.appendChild(renderer.view);

      /* Create a container object called the `stage` */
      stage = new PIXI.Container();
    }
    resetAnimation();
    createCircles();
    function update(time) {
      TWEEN.update(time);

      /* Loop this function */
      requestAnimationFrame(update);

      /* Tell the `renderer` to `render` the `stage` */
      renderer.render(stage);

      /* Record Video */
      if (capturer) capturer.capture(renderer.view);
    }
    requestAnimationFrame(update);

    function randomColor() {
      return Math.floor(Math.random() * 16777215).toString(16);
    }

  </script>
</body>

</html>